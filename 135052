format 74
"touchlag" // framework::base::tests::touchlag
  revision 1
  modified_by 12 "shchen"
  // class settings
  //class diagram settings
  draw_all_relations default hide_attributes default hide_operations default hide_getset_operations default show_members_full_definition default show_members_visibility default show_members_stereotype default show_members_context default show_members_multiplicity default show_members_initialization default show_attribute_modifiers default member_max_width 0 show_parameter_dir default show_parameter_name default package_name_in_tab default class_drawing_mode default drawing_language default show_context_mode default auto_label_position default show_relation_modifiers default show_relation_visibility default show_infonote default shadow default show_stereotype_properties default
  //use case diagram settings
  package_name_in_tab default show_context default auto_label_position default draw_all_relations default class_drawing_mode default shadow default show_stereotype_properties default
  //sequence diagram settings
  show_full_operations_definition default write_horizontally default class_drawing_mode default drawing_language default draw_all_relations default shadow default show_stereotype_properties default show_class_context_mode default show_msg_context_mode default
  //collaboration diagram settings
  show_full_operations_definition default show_hierarchical_rank default write_horizontally default drawing_language default package_name_in_tab default show_context default show_msg_context default draw_all_relations default shadow default show_stereotype_properties default
  //object diagram settings
   write_horizontally default package_name_in_tab default show_context default auto_label_position default draw_all_relations default shadow default show_stereotype_properties default
  //component diagram settings
  package_name_in_tab default show_context default auto_label_position default draw_all_relations default shadow default
  draw_component_as_icon default show_component_req_prov default show_component_rea default show_stereotype_properties default
  //deployment diagram settings
  package_name_in_tab default show_context default write_horizontally default auto_label_position default draw_all_relations default shadow default
  draw_component_as_icon default show_component_req_prov default show_component_rea default show_stereotype_properties default
  //state diagram settings
  package_name_in_tab default show_context default auto_label_position default write_trans_label_horizontally default show_trans_definition default draw_all_relations default shadow default
  show_activities default region_horizontally default drawing_language default show_stereotype_properties default
  //activity diagram settings
  package_name_in_tab default show_context default show_opaque_action_definition default auto_label_position default write_flow_label_horizontally default draw_all_relations default shadow default
  show_infonote default drawing_language default show_stereotype_properties default
  
  cpp_h_dir "/home/shchen/work/jellybean/framework/base/tests/touchlag/"
  cpp_src_dir "/home/shchen/work/jellybean/framework/base/tests/touchlag/"
  classview 131724 "touchlag"
    //class diagram settings
    draw_all_relations default hide_attributes default hide_operations default hide_getset_operations default show_members_full_definition default show_members_visibility default show_members_stereotype default show_members_context default show_members_multiplicity default show_members_initialization default show_attribute_modifiers default member_max_width 0 show_parameter_dir default show_parameter_name default package_name_in_tab default class_drawing_mode default drawing_language default show_context_mode default auto_label_position default show_relation_modifiers default show_relation_visibility default show_infonote default shadow default show_stereotype_properties default
    //collaboration diagram settings
    show_full_operations_definition default show_hierarchical_rank default write_horizontally default drawing_language default package_name_in_tab default show_context default show_msg_context default draw_all_relations default shadow default show_stereotype_properties default
    //object diagram settings
     write_horizontally default package_name_in_tab default show_context default auto_label_position default draw_all_relations default shadow default show_stereotype_properties default
    //sequence diagram settings
    show_full_operations_definition default write_horizontally default class_drawing_mode default drawing_language default draw_all_relations default shadow default show_stereotype_properties default show_class_context_mode default show_msg_context_mode default
    //state diagram settings
    package_name_in_tab default show_context default auto_label_position default write_trans_label_horizontally default show_trans_definition default draw_all_relations default shadow default
    show_activities default region_horizontally default drawing_language default show_stereotype_properties default
    //class settings
    //activity diagram settings
    package_name_in_tab default show_context default show_opaque_action_definition default auto_label_position default write_flow_label_horizontally default draw_all_relations default shadow default
    show_infonote default drawing_language default show_stereotype_properties default
    class 173196 "Buffer"
      visibility package stereotype "struct"
      cpp_decl "${comment}${template}struct ${name}${inherit} {
${members}};
${inlines}
"
      java_decl ""
      php_decl ""
      python_2_2 python_decl ""
      idl_decl ""
      explicit_switch_type ""
      
      attribute 1759884 "w"
	public explicit_type "size_t"
	cpp_decl "    ${comment}${static}${mutable}${volatile}${const}${type} ${name}${value};
"
	java_decl ""
	php_decl ""
	python_decl ""
	idl_decl ""
      end

      attribute 1760012 "h"
	public explicit_type "size_t"
	cpp_decl "    ${comment}${static}${mutable}${volatile}${const}${type} ${name}${value};
"
	java_decl ""
	php_decl ""
	python_decl ""
	idl_decl ""
      end

      attribute 1760140 "s"
	public explicit_type "size_t"
	cpp_decl "    ${comment}${static}${mutable}${volatile}${const}${type} ${name}${value};
"
	java_decl ""
	php_decl ""
	python_decl ""
	idl_decl ""
      end

      attribute 1760268 "addr"
	public explicit_type "void"
	cpp_decl "    ${comment}${static}${mutable}${volatile}${const}${type} * ${name}${value};
"
	java_decl ""
	php_decl ""
	python_decl ""
	idl_decl ""
      end

      attribute 1760396 "pixels"
	public explicit_type "uint32_t"
	cpp_decl "    ${comment}${static}${mutable}${volatile}${const}${type} * ${name}${value};
"
	java_decl ""
	php_decl ""
	python_decl ""
	idl_decl ""
      end
    end

    class 651148 "Queue"
      visibility package stereotype "struct"
      cpp_decl "${comment}${template}struct ${name}${inherit} {
${members}};
${inlines}
"
      java_decl ""
      php_decl ""
      python_2_2 python_decl ""
      idl_decl ""
      explicit_switch_type ""
      
      class 655500 "position"
	visibility package stereotype "struct"
	cpp_decl "${comment}${template}struct ${name}${inherit} {
${members}};
${inlines}
"
	java_decl ""
	php_decl ""
	python_2_2 python_decl ""
	idl_decl ""
	explicit_switch_type ""
	
      end

      attribute 1760652 "index"
	public explicit_type "int"
	cpp_decl "    ${comment}${static}${mutable}${volatile}${const}${type} ${name}${value};
"
	java_decl ""
	php_decl ""
	python_decl ""
	idl_decl ""
      end

      classrelation 1365260 // q (<directional composition>)
	relation 1365260 *-->
	  a role_name "q" multiplicity "[16]" public
	    cpp default "    ${comment}${static}${mutable}${volatile}${const}${type} ${name}${multiplicity}${value};
"
	    classrelation_ref 1365260 // q (<directional composition>)
	  b parent class_ref 655500 // position
      end

      operation 2024588 "Queue"
	cpp_inline public explicit_return_type ""
	nparams 0
	cpp_decl "    ${comment}${inline}${name}${(}${)}${volatile}${throw} : index(0) { };
"
	
	
	
	
      end

      operation 2024716 "push"
	cpp_inline public explicit_return_type "void"
	nparams 2
	  param in name "x" explicit_type "int"
	  param in name "y" explicit_type "int"
	cpp_decl "    ${comment}${friend}${static}${inline}${virtual}${type} ${name}${(}${t0} ${p0}${v0}, ${t1} ${p1}${v1}${)}${const}${volatile}${throw}${abstract} {
        index++;
        index &= 0xF;
        q[index].x = x;
        q[index].y = y;
    };
"
	
	
	
	
      end

      operation 2024844 "get"
	cpp_inline public explicit_return_type "void"
	nparams 3
	  param in name "lag" explicit_type "int"
	  param inout name "x" explicit_type "int"
	  param inout name "y" explicit_type "int"
	cpp_decl "    ${comment}${friend}${static}${inline}${virtual}${type} ${name}${(}${t0} ${p0}${v0}, ${t1} * ${p1}${v1}, ${t2} * ${p2}${v2}${)}${const}${volatile}${throw}${abstract} {
        const int i = (index - lag) & 0xF;
        *x = q[i].x;
        *y = q[i].y;
    };
"
	
	
	
	
      end
    end

    class 655244 "TouchEvents"
      visibility package 
      cpp_decl "${comment}${template}class ${name}${inherit} {
${members}};
${inlines}
"
      java_decl ""
      php_decl ""
      python_2_2 python_decl ""
      idl_decl ""
      explicit_switch_type ""
      
      class 655372 "EventThread"
	visibility package 
	cpp_decl "${comment}${template}class ${name}${inherit} {
${members}};
${inlines}
"
	java_decl ""
	php_decl ""
	python_2_2 python_decl ""
	idl_decl ""
	explicit_switch_type ""
	
	classrelation 1365004 // <generalisation>
	  relation 1365004 ---|>
	    a public
	      cpp default "${type}"
	      classrelation_ref 1365004 // <generalisation>
	    b parent class_ref 159500 // Thread
	end

	attribute 1760524 "fd"
	  private explicit_type "int"
	  cpp_decl "    ${comment}${static}${mutable}${volatile}${const}${type} ${name}${value};
"
	  java_decl ""
	  php_decl ""
	  python_decl ""
	  idl_decl ""
	end

	operation 2024076 "threadLoop"
	  cpp_virtual cpp_inline private explicit_return_type "bool"
	  nparams 0
	  cpp_decl "    ${comment}${friend}${static}${inline}${virtual}${type} ${name}${(}${)}${const}${volatile}${throw}${abstract} {
            input_event event;
            int first_down = 0;
            do {
                read(fd, &event, sizeof(event));
                if (event.type == EV_ABS) {
                    if (event.code == ABS_MT_TRACKING_ID) {
                        down = event.value == -1 ? 0 : 1;
                        first_down = down;
                    }
                    if (event.code == ABS_MT_POSITION_X) {
                        x = event.value;
                    }
                    if (event.code == ABS_MT_POSITION_Y) {
                        y = event.value;
                    }
                }
            } while (event.type == EV_SYN);
            return true;
        };
"
	  
	  
	  
	  
	end

	operation 2024204 "EventThread"
	  cpp_inline public explicit_return_type ""
	  nparams 0
	  cpp_decl "    ${comment}${inline}${name}${(}${)}${volatile}${throw} : Thread(false),
                x(0), y(0), down(0)
        {
            fd = open(\"/dev/input/event1\", O_RDONLY);
        };
"
	  
	  
	  
	  
	end
      end

      classrelation 1365132 // thread (<directional composition>)
	relation 1365132 *-->
	  stereotype "sp"
	  a role_name "thread" private
	    cpp default "    ${comment}${static}${mutable}${volatile}${const}${stereotype}<${type}> ${name}${value};
"
	    classrelation_ref 1365132 // thread (<directional composition>)
	  b parent class_ref 655372 // EventThread
      end

      operation 2024332 "TouchEvents"
	cpp_inline public explicit_return_type ""
	nparams 0
	cpp_decl "    ${comment}${inline}${name}${(}${)}${volatile}${throw} {
        thread = new EventThread();
        thread->run(\"EventThread\", PRIORITY_URGENT_DISPLAY);
    };
"
	
	
	
	
      end

      operation 2024460 "getMostRecentPosition"
	cpp_inline public explicit_return_type "int"
	nparams 2
	  param inout name "x" explicit_type "int"
	  param inout name "y" explicit_type "int"
	cpp_decl "    ${comment}${friend}${static}${inline}${virtual}${type} ${name}${(}${t0} * ${p0}${v0}, ${t1} * ${p1}${v1}${)}${const}${volatile}${throw}${abstract} {
        *x = thread->x;
        *y = thread->y;
        return thread->down;
    };
"
	
	
	
	
      end
    end
  end

  deploymentview 158988 "touchlag"
    //deployment diagram settings
    package_name_in_tab default show_context default write_horizontally default auto_label_position default draw_all_relations default shadow default
    draw_component_as_icon default show_component_req_prov default show_component_rea default show_stereotype_properties default
    artifact 295820 "Buffer"
      stereotype "source"
      cpp_h "#ifndef ${NAMESPACE}_${NAME}_H
#define ${NAMESPACE}_${NAME}_H

${comment}
${includes}
${declarations}
${namespace_start}
${definition}
${namespace_end}
#endif
"
      cpp_src "${comment}
${includes}
${namespace_start}
${members}
${namespace_end}"
      associated_classes
	class_ref 173196 // Buffer
      end
    end

    artifact 295948 "TouchEvents"
      stereotype "source"
      cpp_h "#ifndef ${NAMESPACE}_${NAME}_H
#define ${NAMESPACE}_${NAME}_H

${comment}
${includes}
${declarations}
${namespace_start}
${definition}
${namespace_end}
#endif
"
      cpp_src "${comment}
${includes}
${namespace_start}
${members}
${namespace_end}"
      associated_classes
	class_ref 655244 // TouchEvents
      end
    end

    artifact 296076 "Queue"
      stereotype "source"
      cpp_h "#ifndef ${NAMESPACE}_${NAME}_H
#define ${NAMESPACE}_${NAME}_H

${comment}
${includes}
${declarations}
${namespace_start}
${definition}
${namespace_end}
#endif
"
      cpp_src "${comment}
${includes}
${namespace_start}
${members}
${namespace_end}"
      associated_classes
	class_ref 651148 // Queue
      end
    end

    artifact 296204 "main"
      stereotype "source"
      cpp_src "int main(int argc, char** argv) {
    fb_var_screeninfo vi;
    fb_fix_screeninfo fi;

    int lag = 0;
    int fd = open(\"/dev/graphics/fb0\", O_RDWR);
    ioctl(fd, FBIOGET_VSCREENINFO, &vi);
    ioctl(fd, FBIOGET_FSCREENINFO, &fi);
    void* bits = mmap(0, fi.smem_len, PROT_READ | PROT_WRITE, MAP_SHARED, fd, 0);
    Buffer framebuffer;
    framebuffer.w = vi.xres;
    framebuffer.h = vi.yres;
    framebuffer.s = fi.line_length / (vi.bits_per_pixel >> 3);
    framebuffer.addr = bits;

    int ch;
    while ((ch = getopt(argc, argv, \"hl:\")) != -1) {
        switch (ch) {
            case 'l':
                lag = atoi(optarg);
                break;
            case 'h':
            default:
                usage(argv[0]);
                exit(0);
        }
    }
    argc -= optind;
    argv += optind;


    TouchEvents touch;
    Queue queue;


    int x=0, y=0, down=0;
    int lag_x=0, lag_y=0;

    clearBuffer(&framebuffer, 0);
    while (true) {
        uint32_t crt = 0;
        int err = ioctl(fd, FBIO_WAITFORVSYNC, &crt);

        // draw beam marker
        drawRect(&framebuffer, 0x400000, framebuffer.w-2, 0, 2, framebuffer.h);
        // erase screen
        if (lag) {
            drawCircle(&framebuffer, 0, lag_x, lag_y, 100);
            drawHLine(&framebuffer, 0, 0, lag_y, 32);
        }
        drawCircle(&framebuffer, 0, x, y, 100, true);
        drawHLine(&framebuffer, 0, 0, y, 32);

        // draw a line at y=1000
        drawHLine(&framebuffer, 0x808080, 0, 1000, framebuffer.w);

        // get touch events
        touch.getMostRecentPosition(&x, &y);
        queue.push(x, y);
        queue.get(lag, &lag_x, &lag_y);

        if (lag) {
            drawCircle(&framebuffer, 0x00FF00, lag_x, lag_y, 100);
            drawHLine(&framebuffer, 0x00FF00, 0, lag_y, 32);
        }

        drawCircle(&framebuffer, 0xFFFFFF, x, y, 100, true);
        drawHLine(&framebuffer, 0xFFFFFF, 0, y, 32);

        // draw end of frame beam marker
        drawRect(&framebuffer, 0x004000, framebuffer.w-2, 0, 2, framebuffer.h);
    }

    close(fd);
    return 0;
}
"
      associated_classes
      end
    end
  end
end
